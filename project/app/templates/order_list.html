{% extends 'base.html' %}

{% block title %}
Order List
{% endblock title %}

{% block content %}
<section class="section">
  <div class="container">
    <!-- Project Context Header -->
    <div class="project-context mb-5">
      <div class="level">
        <div class="level-left">
          <div class="level-item">
            <div>
              <h1 class="title is-4 mb-1">
                <i class="fas fa-folder-open has-text-primary"></i>
                {{ project.title }}
              </h1>
              <p class="subtitle is-6 has-text-grey">
                <strong>Project:</strong> {{ project.alias }} • 
                <strong>Orders:</strong> {{ orders|length }}
                {% if project.description %}
                • {{ project.description|truncatechars:80 }}
                {% endif %}
              </p>
            </div>
          </div>
        </div>
        <div class="level-right">
          <div class="level-item">
            <a href="{% url 'project_list' %}" class="button is-light">
              <span class="icon">
                <i class="fas fa-arrow-left"></i>
              </span>
              <span>Back to Projects</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Section -->
    <div class="orders-section">
      <h2 class="title has-text-centered">Sequencing Orders</h2>
      <p class="has-text-centered">
        Track your sequencing orders from submission to data delivery. Each order is associated with one or more samples following MIxS standards.
      </p>
    </div>
    {% if orders %}
      <div class="orders-container">
        {% for order in orders %}
          <div class="order-card">
            <!-- Order Header -->
            <div class="order-header">
              <div class="order-info">
                <h3 class="order-title">Order #{{ order.id }}</h3>
                <span class="tag {{ order.get_status_display_color }} is-medium">
                  {{ order.get_status_display }}
                </span>
                {% if order.status_notes %}
                  <p class="order-notes">{{ order.status_notes|truncatechars:80 }}</p>
                {% endif %}
              </div>
              <div class="order-actions">
                <a href="{% url 'order_edit' project_id=project_id order_id=order.id %}" 
                   class="button is-info is-outlined">
                  <span class="icon">
                    <i class="fas fa-edit"></i>
                  </span>
                  <span>Edit</span>
                </a>
                <a class="button is-danger is-outlined" 
                   onclick="deleteOrder('{% url 'delete_order' project_id=project_id order_id=order.id %}')">
                  <span class="icon">
                    <i class="fas fa-trash"></i>
                  </span>
                  <span>Delete</span>
                </a>
              </div>
            </div>

            <!-- Workflow Progress -->
            <div class="workflow-progress">
              <div class="progress-steps">
                <!-- Step 1: Create Order -->
                <div class="progress-step completed">
                  <div class="step-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="step-label">Create Order</div>
                </div>
                
                <!-- Step 2: Metadata Setup -->
                <div class="progress-step {% if not order.show_metadata %}active{% else %}completed{% endif %}">
                  <div class="step-icon">
                    {% if order.show_metadata %}
                      <i class="fas fa-check-circle"></i>
                    {% else %}
                      <i class="fas fa-clipboard-list"></i>
                    {% endif %}
                  </div>
                  <div class="step-label">Configure Metadata</div>
                </div>
                
                <!-- Step 3: Sample Data -->
                <div class="progress-step {% if order.show_metadata and not order.show_samples %}active{% elif order.show_samples %}completed{% endif %}">
                  <div class="step-icon">
                    {% if order.show_samples %}
                      <i class="fas fa-check-circle"></i>
                    {% elif order.show_metadata %}
                      <i class="fas fa-dna"></i>
                    {% else %}
                      <i class="fas fa-dna disabled"></i>
                    {% endif %}
                  </div>
                  <div class="step-label">Add Samples</div>
                </div>
                
                <!-- Step 4: Review & Submit -->
                <div class="progress-step {% if order.show_samples and order.status == 'draft' %}active{% elif order.status != 'draft' %}completed{% endif %}">
                  <div class="step-icon">
                    {% if order.status != 'draft' %}
                      <i class="fas fa-check-circle"></i>
                    {% elif order.show_samples %}
                      <i class="fas fa-rocket"></i>
                    {% else %}
                      <i class="fas fa-rocket disabled"></i>
                    {% endif %}
                  </div>
                  <div class="step-label">Review & Submit</div>
                </div>
                
                <!-- Step 5: Sequencing (Waiting/Admin) -->
                {% if order.is_waiting_for_facility %}
                <div class="progress-step active">
                  <div class="step-icon">
                    <i class="fas fa-clock"></i>
                  </div>
                  <div class="step-label">Sequencing</div>
                  <div class="step-optional">(In Progress)</div>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Current Action -->
            <div class="current-action">
              {% if not order.show_metadata %}
                <div class="action-guidance">
                  <h4 class="action-title">
                    <i class="fas fa-clipboard-list"></i>
                    Step 2: Configure Metadata Checklists
                  </h4>
                  <p class="action-description">
                    Define MIxS (Minimum Information about any Sequence) standards for your samples. This determines what metadata fields you'll need to fill out.
                  </p>
                  <a href="{% url 'metadata_view' project_id=project_id order_id=order.id %}" 
                     class="button is-primary is-medium">
                    <span class="icon">
                      <i class="fas fa-clipboard-list"></i>
                    </span>
                    <span>Setup Checklists</span>
                  </a>
                </div>
              {% elif not order.show_samples %}
                <div class="action-guidance">
                  <h4 class="action-title">
                    <i class="fas fa-dna"></i>
                    Step 3: Add Sample Data
                  </h4>
                  <p class="action-description">
                    Enter detailed information about your samples following the MIxS standards you've configured.
                  </p>
                  <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=1%}" 
                     class="button is-primary is-medium">
                    <span class="icon">
                      <i class="fas fa-dna"></i>
                    </span>
                    <span>Add Sample Data</span>
                  </a>
                </div>
              {% elif order.status == 'draft' %}
                <div class="action-guidance">
                  <h4 class="action-title">
                    <i class="fas fa-rocket"></i>
                    Step 4: Review & Submit for Sequencing
                  </h4>
                  <p class="action-description">
                    Your order is complete! Review your order details and submit for sequencing. You can optionally add analysis samples (Assembly, Binning, MAG) before submitting.
                  </p>
                  <div class="buttons">
                    {% if order.can_advance_status %}
                      <button class="button is-success is-medium" 
                              onclick="advanceStatus({{ order.id }}, '{{ order.get_next_status }}')">
                        <span class="icon">
                          <i class="fas fa-rocket"></i>
                        </span>
                        <span>Submit for Sequencing</span>
                      </button>
                    {% endif %}
                  </div>
                </div>
              {% elif order.is_waiting_for_facility %}
                <div class="action-guidance">
                  <h4 class="action-title">
                    <i class="fas fa-clock"></i>
                    Step 5: Sequencing in Progress
                  </h4>
                  <p class="action-description">
                    Your order has been submitted and is being processed by the sequencing facility. You will be notified when sequencing is complete and data is available.
                  </p>
                  <div class="notification is-info is-light">
                    <p><strong>Current Status:</strong> {{ order.get_status_display }}</p>
                    {% if order.status_notes %}
                      <p><strong>Notes:</strong> {{ order.status_notes }}</p>
                    {% endif %}
                  </div>
                  {% if order.can_advance_status and user.is_staff %}
                    <button class="button is-primary is-medium" 
                            onclick="advanceStatus({{ order.id }}, '{{ order.get_next_status }}')">
                      <span class="icon">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                      <span>Advance Status (Admin)</span>
                    </button>
                  {% endif %}
                </div>
              {% else %}
                <div class="action-guidance">
                  <h4 class="action-title">
                    <i class="fas fa-check-circle"></i>
                    Order Completed
                  </h4>
                  <p class="action-description">
                    Your sequencing order has been completed successfully!
                  </p>
                </div>
              {% endif %}
            </div>

            <!-- Optional Actions -->
            {% if order.show_samples %}
              <div class="optional-actions">
                <h5 class="optional-title">Optional Analysis Samples</h5>
                <div class="optional-buttons">
                  {% if order.show_assembly %}
                    <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=2%}" 
                       class="button is-info is-small">
                      <span class="icon"><i class="fas fa-puzzle-piece"></i></span>
                      <span>Edit Assembly Samples</span>
                    </a>
                  {% else %}
                    <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=2%}" 
                       class="button is-light is-small">
                      <span class="icon"><i class="fas fa-puzzle-piece"></i></span>
                      <span>Add Assembly Samples</span>
                    </a>
                  {% endif %}
                  
                  {% if order.show_bin %}
                    <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=3%}" 
                       class="button is-info is-small">
                      <span class="icon"><i class="fas fa-layer-group"></i></span>
                      <span>Edit Binning Samples</span>
                    </a>
                    <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=4%}" 
                       class="button is-info is-small">
                      <span class="icon"><i class="fas fa-cubes"></i></span>
                      <span>Edit MAG Samples</span>
                    </a>
                  {% else %}
                    <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=3%}" 
                       class="button is-light is-small">
                      <span class="icon"><i class="fas fa-layer-group"></i></span>
                      <span>Add Binning Samples</span>
                    </a>
                    <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=4%}" 
                       class="button is-light is-small">
                      <span class="icon"><i class="fas fa-cubes"></i></span>
                      <span>Add MAG Samples</span>
                    </a>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="has-text-centered">No orders found.</p>
    {% endif %}

    <div class="has-text-centered mt-6">
        <a href="{% url 'order_create' project_id %}" class="button is-primary is-medium">
          <span class="icon">
            <i class="fas fa-plus"></i>
          </span>
          <span>Request New Order</span>
        </a>
    </div>

</section>

<script>
function deleteOrder(url, orderId) {
    if (confirm('Are you sure you want to delete this order, and all related objects (samples, reads, analyses)?')) {
        window.location.href = url;
    }
}

function advanceStatus(orderId, nextStatus) {
    const statusNames = {
        'ready_for_sequencing': 'Ready for Sequencing',
        'sequencing_in_progress': 'Sequencing in Progress',
        'sequencing_completed': 'Sequencing Completed',
        'data_processing': 'Data Processing',
        'data_delivered': 'Data Delivered',
        'completed': 'Completed'
    };
    
    const message = `Are you sure you want to advance this order to "${statusNames[nextStatus]}"?`;
    
    if (confirm(message)) {
        // For now, just reload the page - in a real implementation, this would be an AJAX call
        // TODO: Implement AJAX endpoint for status updates
        fetch(`/api/orders/${orderId}/advance-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                'new_status': nextStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating status: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating status. Please try again.');
            console.error('Error:', error);
        });
    }
}
</script>
{% endblock content %}