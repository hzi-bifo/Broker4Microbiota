{% extends 'base.html' %}

{% block title %}
Order List
{% endblock title %}

{% block content %}
<section class="section">
  <div class="container">
    <h2 class="title has-text-centered">{{ site_settings.organization_short_name }} Sequencing Orders</h2>
    <p class="has-text-centered">
      Track your sequencing orders from submission to data delivery. Each order is associated with one or more samples following MIxS standards.
    </p>
    {% if orders %}
      <div class="table-container">
        <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Status</th>
              <th>Order Actions</th>
              <th>Metadata</th>
              <th>Samples</th>
              <th>Analysis Samples</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
              <tr>
                <td><strong>#{{ order.id }}</strong></td>
                <td>
                  <div class="status-container">
                    <span class="tag {{ order.get_status_display_color }}">
                      {{ order.get_status_display }}
                    </span>
                    {% if order.can_advance_status %}
                      <button class="button is-small is-outlined is-primary ml-2" 
                              onclick="advanceStatus({{ order.id }}, '{{ order.get_next_status }}')">
                        <span class="icon is-small">
                          <i class="fas fa-arrow-right"></i>
                        </span>
                        <span>Next</span>
                      </button>
                    {% endif %}
                  </div>
                  {% if order.status_notes %}
                    <p class="is-size-7 has-text-grey mt-1">{{ order.status_notes|truncatechars:50 }}</p>
                  {% endif %}
                </td>
                <td>
                  <div class="buttons has-addons">
                    <a href="{% url 'order_edit' project_id=project_id order_id=order.id %}" 
                       class="button is-small is-info">
                      <span class="icon">
                        <i class="fas fa-edit"></i>
                      </span>
                      <span>Edit</span>
                    </a>
                    <a class="button is-small is-danger" 
                       onclick="deleteOrder('{% url 'delete_order' project_id=project_id order_id=order.id %}')">
                      <span class="icon">
                        <i class="fas fa-trash"></i>
                      </span>
                      <span>Delete</span>
                    </a>
                  </div>
                </td>
                <td>
                {% if order.show_metadata %}
                  <a href="{% url 'metadata_view' project_id=project_id order_id=order.id %}" class="button is-small is-primary">Checklists</a>
                {% else %}
                  <a class="button is-small is-light" title="Disabled - delete all samples to allow change of checklist">Checklists</a>
                {% endif %} 
                </td>
                <td>
                {% if order.show_samples %}
                  <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=1%}" class="button is-small is-primary">Edit Samples</a>
                {% else %}
                  <a class="button is-small is-light" title="Disabled - no checklists selected">Edit Samples</a>  
                {% endif %}
                </td>
                <td>
                  {% if order.show_assembly %}
                  <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=2%}" class="button is-small is-primary">Edit Assembly Samples</a>
                  {% else %}
                  <a class="button is-small is-light" title="Disabled - no assemblies (or samples) present">Edit Assembly Samples</a>
                  {% endif %}
                  {% if order.show_bin %}
                  <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=3%}" class="button is-small is-primary">Edit Binning Samples</a>
                  <a href="{% url 'samples_view' project_id=project_id order_id=order.id sample_type=4%}" class="button is-small is-primary">Edit MAG Samples</a>
                  {% else %}
                  <a class="button is-small is-light" title="Disabled - no bins (or samples) present">Edit Binning Samples</a>
                  <a class="button is-small is-light" title="Disabled - no bins (or samples) present">Edit MAG Samples</a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="has-text-centered">No orders found.</p>
    {% endif %}

    <div class="has-text-centered mt-6">
        <a href="{% url 'order_create' project_id %}" class="button is-primary is-medium">
          <span class="icon">
            <i class="fas fa-plus"></i>
          </span>
          <span>Request New Order</span>
        </a>
        <a href="{% url 'project_list' %}" class="button is-link is-light is-medium ml-3">
          <span class="icon">
            <i class="fas fa-arrow-left"></i>
          </span>
          <span>Back to Projects</span>
        </a>
    </div>

</section>

<script>
function deleteOrder(url, orderId) {
    if (confirm('Are you sure you want to delete this order, and all related objects (samples, reads, analyses)?')) {
        window.location.href = url;
    }
}

function advanceStatus(orderId, nextStatus) {
    const statusNames = {
        'ready_for_sequencing': 'Ready for Sequencing',
        'sequencing_in_progress': 'Sequencing in Progress',
        'sequencing_completed': 'Sequencing Completed',
        'data_processing': 'Data Processing',
        'data_delivered': 'Data Delivered',
        'completed': 'Completed'
    };
    
    const message = `Are you sure you want to advance this order to "${statusNames[nextStatus]}"?`;
    
    if (confirm(message)) {
        // For now, just reload the page - in a real implementation, this would be an AJAX call
        // TODO: Implement AJAX endpoint for status updates
        fetch(`/api/orders/${orderId}/advance-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                'new_status': nextStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating status: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating status. Please try again.');
            console.error('Error:', error);
        });
    }
}
</script>
{% endblock content %}