{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}
{{ site_settings.project_form_title }}
{% endblock title %}

{% block content %}
<section class="section">
  <div class="container">
    <div class="form-card">
      <div class="form-card-header">
        <h2>{{ site_settings.project_form_title }}</h2>
        <p>{{ site_settings.project_form_description }}</p>
      </div>
      
      <div class="form-card-body">
        <form method="post" id="projectForm">
          {% csrf_token %}
          
          {% if form.non_field_errors %}
            <div class="notification is-danger is-light">
              {% for error in form.non_field_errors %}
                {{ error }}
              {% endfor %}
            </div>
          {% endif %}

          <!-- Title Field -->
          <div class="field">
            <label class="label {% if form.title.field.required %}required{% endif %}">
              <i class="fas fa-heading"></i> {{ form.title.label }}
            </label>
            <div class="control">
              {{ form.title|add_class:"input" }}
            </div>
            <p class="help">Choose a descriptive title that clearly identifies your research project or study.</p>
            {% if form.title.errors %}
              {% for error in form.title.errors %}
                <p class="help is-danger">{{ error }}</p>
              {% endfor %}
            {% endif %}
          </div>

          <!-- Alias Field -->
          <div class="field">
            <label class="label {% if form.alias.field.required %}required{% endif %}">
              <i class="fas fa-tag"></i> {{ form.alias.label }}
            </label>
            <div class="control">
              {{ form.alias|add_class:"input" }}
            </div>
            <p class="help">A short, unique identifier for your project (e.g., internal code or lab abbreviation).</p>
            {% if form.alias.errors %}
              {% for error in form.alias.errors %}
                <p class="help is-danger">{{ error }}</p>
              {% endfor %}
            {% endif %}
          </div>

          <!-- Description Field -->
          <div class="field">
            <label class="label {% if form.description.field.required %}required{% endif %}">
              <i class="fas fa-align-left"></i> {{ form.description.label }}
            </label>
            <div class="control">
              {{ form.description|add_class:"textarea" }}
            </div>
            <p class="help">Include research objectives, sample types, experimental design, and expected outcomes.</p>
            {% if form.description.errors %}
              {% for error in form.description.errors %}
                <p class="help is-danger">{{ error }}</p>
              {% endfor %}
            {% endif %}
          </div>

          <!-- Submitted Checkbox -->
          <div class="field">
            <div class="control">
              <label class="checkbox">
                {{ form.submitted }}
                Already submitted to ENA
                <span class="help-icon" data-tooltip="Check this only if this project has already been submitted to the European Nucleotide Archive (ENA) and has received an accession number.">
                  <i class="fas fa-question-circle"></i>
                </span>
              </label>
            </div>
          </div>

          <!-- Study Accession ID (Read-only) -->
          {% if form.study_accession_id %}
          <div class="field">
            <label class="label">
              <i class="fas fa-database"></i> {{ form.study_accession_id.label }}
            </label>
            <div class="control">
              {{ form.study_accession_id|add_class:"input" }}
            </div>
            <p class="help">Automatically populated after ENA submission (Format: PRJEB######)</p>
          </div>
          {% endif %}

          <!-- Alternative Accession ID (Read-only) -->
          {% if form.alternative_accession_id %}
          <div class="field">
            <label class="label">
              <i class="fas fa-key"></i> {{ form.alternative_accession_id.label }}
            </label>
            <div class="control">
              {{ form.alternative_accession_id|add_class:"input" }}
            </div>
            <p class="help">Optional alternative identifier (e.g., BioProject ID)</p>
          </div>
          {% endif %}

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="submit" class="button is-primary">
              <span class="icon">
                <i class="fas fa-check"></i>
              </span>
              <span>Submit Project</span>
            </button>
            <button type="button" class="button is-light" onclick="clearForm()">
              <span class="icon">
                <i class="fas fa-eraser"></i>
              </span>
              <span>Clear Form</span>
            </button>
            <a href="{% url 'project_list' %}" class="button is-light">
              <span class="icon">
                <i class="fas fa-times"></i>
              </span>
              <span>Cancel</span>
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
{% endblock content %}

{% block scripts %}
<script>
// Clear form function
function clearForm() {
  if (confirm('Are you sure you want to clear all form fields?')) {
    document.getElementById('projectForm').reset();
    // Re-focus on first input
    document.querySelector('input[type="text"]:not([readonly])').focus();
  }
}

// Add real-time validation
document.addEventListener('DOMContentLoaded', function() {
  const inputs = document.querySelectorAll('.input, .textarea');
  
  inputs.forEach(input => {
    input.addEventListener('blur', function() {
      // Check if field is required
      const field = this.closest('.field');
      const label = field.querySelector('.label.required');
      
      if (this.hasAttribute('required') || label) {
        if (this.value.trim() === '') {
          this.classList.add('is-danger');
          this.classList.remove('is-success');
        } else {
          this.classList.add('is-success');
          this.classList.remove('is-danger');
        }
      }
    });
    
    // Remove validation classes on focus
    input.addEventListener('focus', function() {
      this.classList.remove('is-success', 'is-danger');
    });
  });
});
</script>
{% endblock scripts %}