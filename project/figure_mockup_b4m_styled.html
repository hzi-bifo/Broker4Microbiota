<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Broker4Microbiota - Figure Components</title>
    
    <!-- B4M CSS Stack -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Handsontable CSS -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css" rel="stylesheet">
    
    <style>
    /* B4M Theme Colors */
    :root {
        --primary-color: #3273dc;
        --secondary-color: #2366d1;
    }
    
    /* Base Styles from B4M */
    body {
        background-color: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    /* Figure Container */
    .figure-container {
        max-width: 1800px;
        margin: 20px auto;
        background: white;
        padding: 40px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 8px;
    }
    
    .figure-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .panel {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }
    
    .panel-header {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 15px 20px;
        border-bottom: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .panel-label {
        background: var(--primary-color);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(50, 115, 220, 0.2);
    }
    
    .panel-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.1rem;
    }
    
    .panel-content {
        padding: 20px;
        min-height: 400px;
    }
    
    /* Set specific height for panels C and D */
    #panel-c,
    #panel-d {
        height: 729px;
    }
    
    /* Workflow Styles from order_list.html */
    .workflow-progress {
        padding: 1.5rem;
        background: white;
    }
    
    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        position: relative;
        min-height: 120px;
        padding: 20px 0;
    }
    
    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
        flex: 1;
        text-align: center;
    }
    
    .progress-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 25px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #e0e0e0;
        z-index: -1;
    }
    
    .step-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .progress-step.completed .step-icon {
        background: #48c774;
        color: white;
    }
    
    .progress-step.active .step-icon {
        background: #3273dc;
        color: white;
    }
    
    .step-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #363636;
        margin-bottom: 0.25rem;
    }
    
    .step-detail {
        font-size: 0.75rem;
        color: #7a7a7a;
    }
    
    /* Checklist Card Styles from metadata.html */
    .checklist-card {
        margin-bottom: 1rem;
    }
    
    .checklist-card .card {
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        border: 2px solid transparent;
    }
    
    .checklist-card .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .checklist-card.selected .card {
        border-color: var(--primary-color);
        background-color: #f0f7ff;
    }
    
    .selected-indicator {
        position: absolute;
        top: 0;
        right: 0;
        background-color: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0 4px 0 4px;
        font-weight: 600;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 4px rgba(50, 115, 220, 0.3);
    }
    
    .checklist-card .media-left .icon {
        background: #f0f7ff;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Sample Actions Bar from samples.html */
    .sample-actions {
        min-height: 50px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
        margin: -20px -20px 20px -20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .sample-info {
        display: flex;
        align-items: baseline;
        gap: 1rem;
        margin-right: 2rem;
    }
    
    .sample-info .title {
        font-size: 1.1rem;
        margin: 0;
        font-weight: 600;
    }
    
    .sample-info .subtitle {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
    }
    
    /* Handsontable Container */
    .handsontable-container {
        border: 1px solid #dbdbdb;
        border-radius: 4px;
        overflow: hidden;
        height: 440px;
    }
    
    /* Admin Dashboard Stats */
    .stat-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    
    .stat-number {
        font-size: 36px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #7a7a7a;
        font-size: 14px;
        font-weight: 500;
    }
    
    /* Order table styling */
    .order-table {
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
    }
    
    .order-table thead {
        background-color: #f8f9fa;
    }
    
    .order-table thead th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        padding: 1rem;
    }
    
    .order-table td {
        padding: 1rem;
        vertical-align: middle;
    }
    
    /* Button Styles from B4M */
    .button {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
    }
    
    .button:hover {
        transform: translateY(-1px);
    }
    
    .button.is-primary {
        background: var(--primary-color);
        box-shadow: 0 2px 4px rgba(50, 115, 220, 0.2);
    }
    
    .button.is-primary:hover {
        background: var(--secondary-color);
        box-shadow: 0 4px 8px rgba(50, 115, 220, 0.3);
    }
    
    /* Status Tags */
    .tag {
        border-radius: 4px;
        font-weight: 500;
    }
    
    /* Figure Caption */
    .figure-caption {
        margin-top: 40px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.8;
        color: #4a4a4a;
        border: 1px solid #e9ecef;
    }
    
    .figure-caption strong {
        color: #2c3e50;
    }
    /* Export buttons */
    .export-controls {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .panel-export {
        position: absolute;
        top: 10px;
        right: 10px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 10;
    }
    
    .panel:hover .panel-export {
        opacity: 1;
    }
    </style>
    
    <!-- Include html2canvas and jsPDF for export functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Export Controls -->
    <div class="export-controls">
        <button class="button is-primary is-small" onclick="exportAllPanels()">
            <span class="icon"><i class="fas fa-download"></i></span>
            <span>Export All as PDF</span>
        </button>
        <button class="button is-info is-small" onclick="exportHighResPNG()">
            <span class="icon"><i class="fas fa-download"></i></span>
            <span>Export High-Res PNG</span>
        </button>
    </div>
    
    <div class="figure-container">
        <div class="figure-grid">
            <!-- Panel A: Workflow Overview (from order_list.html) -->
            <div class="panel" id="panel-a">
                <button class="button is-small panel-export" onclick="exportPanel('panel-a', 'workflow')">
                    <span class="icon"><i class="fas fa-download"></i></span>
                </button>
                <div class="panel-header">
                    <span class="panel-label">A</span>
                    <span class="panel-title">Broker4M Workflow Overview</span>
                </div>
                <div class="panel-content">
                    <div class="workflow-progress">
                        <div class="progress-steps">
                            <div class="progress-step completed">
                                <div class="step-icon">
                                    <i class="fas fa-folder-open"></i>
                                </div>
                                <div class="step-label">Step 1</div>
                                <div class="step-detail">Project Creation</div>
                            </div>
                            <div class="progress-step completed">
                                <div class="step-icon">
                                    <i class="fas fa-dna"></i>
                                </div>
                                <div class="step-label">Step 2</div>
                                <div class="step-detail">Create Order</div>
                            </div>
                            <div class="progress-step active">
                                <div class="step-icon">
                                    <i class="fas fa-list-check"></i>
                                </div>
                                <div class="step-label">Step 3</div>
                                <div class="step-detail">MIxS Selection</div>
                            </div>
                            <div class="progress-step">
                                <div class="step-icon">
                                    <i class="fas fa-table"></i>
                                </div>
                                <div class="step-label">Step 4</div>
                                <div class="step-detail">Sample Data</div>
                            </div>
                            <div class="progress-step">
                                <div class="step-icon">
                                    <i class="fas fa-paper-plane"></i>
                                </div>
                                <div class="step-label">Step 5</div>
                                <div class="step-detail">Submit</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Examples Below Workflow -->
                    <div class="workflow-forms" style="margin-top: 30px; display: flex; gap: 20px;">
                        <!-- Step 1 Form Example -->
                        <div style="flex: 1; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                            <h5 class="subtitle is-6" style="margin-bottom: 10px; color: #48c774;">
                                <i class="fas fa-folder-open"></i> Step 1: Project Metadata
                            </h5>
                            <div class="field">
                                <label class="label is-small">Project Title <span style="color: red;">*</span></label>
                                <div class="control">
                                    <input class="input is-small" type="text" value="Human Gut Microbiome Study" readonly>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label is-small">Project Description</label>
                                <div class="control">
                                    <textarea class="textarea is-small" rows="2" readonly>Investigation of gut microbiome diversity in healthy individuals...</textarea>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label is-small">ENA Study Accession</label>
                                <div class="control">
                                    <input class="input is-small" type="text" value="PRJEB12345" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2 Form Example -->
                        <div style="flex: 1; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                            <h5 class="subtitle is-6" style="margin-bottom: 10px; color: #48c774;">
                                <i class="fas fa-dna"></i> Step 2: Sequencing Parameters
                            </h5>
                            <div class="field">
                                <label class="label is-small">Sequencing Platform <span style="color: red;">*</span></label>
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select disabled>
                                            <option>Illumina NovaSeq 6000</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label is-small">Library Strategy <span style="color: red;">*</span></label>
                                <div class="control">
                                    <div class="select is-small is-fullwidth">
                                        <select disabled>
                                            <option>WGS (Whole Genome Sequencing)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label is-small">Expected Insert Size</label>
                                <div class="control">
                                    <input class="input is-small" type="text" value="350 bp" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 0.85rem;">
                        <i class="fas fa-info-circle" style="color: #4caf50;"></i>
                        <strong>Customizable Forms:</strong> Facility administrators can modify form fields in Steps 1 & 2 to match institutional requirements
                    </div>
                </div>
            </div>
            
            <!-- Panel B: MIxS Checklist Selection (from metadata.html) -->
            <div class="panel" id="panel-b">
                <button class="button is-small panel-export" onclick="exportPanel('panel-b', 'checklist')">
                    <span class="icon"><i class="fas fa-download"></i></span>
                </button>
                <div class="panel-header">
                    <span class="panel-label">B</span>
                    <span class="panel-title">MIxS Checklist Selection Interface</span>
                </div>
                <div class="panel-content" style="display: flex; gap: 25px;">
                    <!-- Left side: Checklist Selection -->
                    <div style="flex: 1.2;">
                        <!-- Search bar -->
                        <div class="field has-addons" style="margin-bottom: 15px;">
                            <div class="control has-icons-left is-expanded">
                                <input class="input" type="text" placeholder="Search checklists..." value="human" style="border-radius: 6px 0 0 6px;">
                                <span class="icon is-left">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                            <div class="control">
                                <button class="button is-info" style="border-radius: 0 6px 6px 0;">
                                    <span>17 checklists</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Checklist cards container -->
                        <div style="height: 480px; overflow-y: auto; overflow-x: hidden; padding-right: 10px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa; padding: 10px;">
                            <!-- Selected checklist card -->
                            <div class="checklist-card selected" style="margin-bottom: 15px;">
                                <div class="card">
                                    <div class="selected-indicator">
                                        <i class="fas fa-check"></i>
                                        Selected
                                    </div>
                                    <div class="card-content" style="padding: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <div style="flex-shrink: 0;">
                                                <span style="background: #f0f7ff; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-user-md fa-lg has-text-info"></i>
                                                </span>
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="font-size: 1.25rem; font-weight: 600; margin: 0 0 0.25rem 0;">Human Gut</h5>
                                                <p style="font-size: 0.875rem; color: #7a7a7a; margin: 0 0 0.5rem 0;">Gastrointestinal microbiome</p>
                                                <div style="display: flex; gap: 8px;">
                                                    <span class="tag is-info is-light">82 fields</span>
                                                    <span class="tag is-light">MIxS</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Water checklist -->
                            <div class="checklist-card" style="margin-bottom: 15px;">
                                <div class="card">
                                    <div class="card-content" style="padding: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <div style="flex-shrink: 0;">
                                                <span style="background: #f8f9fa; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-water fa-lg has-text-info"></i>
                                                </span>
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="font-size: 1.25rem; font-weight: 600; margin: 0 0 0.25rem 0;">Water</h5>
                                                <p style="font-size: 0.875rem; color: #7a7a7a; margin: 0 0 0.5rem 0;">Aquatic environments</p>
                                                <div style="display: flex; gap: 8px;">
                                                    <span class="tag is-info is-light">95 fields</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Human Skin checklist -->
                            <div class="checklist-card" style="margin-bottom: 15px;">
                                <div class="card">
                                    <div class="card-content" style="padding: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <div style="flex-shrink: 0;">
                                                <span style="background: #f8f9fa; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-user fa-lg has-text-info"></i>
                                                </span>
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="font-size: 1.25rem; font-weight: 600; margin: 0 0 0.25rem 0;">Human Skin</h5>
                                                <p style="font-size: 0.875rem; color: #7a7a7a; margin: 0 0 0.5rem 0;">Dermatological studies</p>
                                                <div style="display: flex; gap: 8px;">
                                                    <span class="tag is-info is-light">73 fields</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Soil checklist -->
                            <div class="checklist-card" style="margin-bottom: 15px;">
                                <div class="card">
                                    <div class="card-content" style="padding: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <div style="flex-shrink: 0;">
                                                <span style="background: #f8f9fa; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-mountain fa-lg has-text-info"></i>
                                                </span>
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="font-size: 1.25rem; font-weight: 600; margin: 0 0 0.25rem 0;">Soil</h5>
                                                <p style="font-size: 0.875rem; color: #7a7a7a; margin: 0 0 0.5rem 0;">Terrestrial soil samples</p>
                                                <div style="display: flex; gap: 8px;">
                                                    <span class="tag is-info is-light">87 fields</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Host Associated checklist -->
                            <div class="checklist-card" style="margin-bottom: 15px;">
                                <div class="card">
                                    <div class="card-content" style="padding: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <div style="flex-shrink: 0;">
                                                <span style="background: #f8f9fa; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-paw fa-lg has-text-info"></i>
                                                </span>
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="font-size: 1.25rem; font-weight: 600; margin: 0 0 0.25rem 0;">Host Associated</h5>
                                                <p style="font-size: 0.875rem; color: #7a7a7a; margin: 0 0 0.5rem 0;">Animal microbiomes</p>
                                                <div style="display: flex; gap: 8px;">
                                                    <span class="tag is-info is-light">76 fields</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- More indicator -->
                            <div style="text-align: center; padding: 15px; color: #7a7a7a; font-size: 0.9rem;">
                                <i class="fas fa-ellipsis-h"></i> 12 more checklists available
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right side: Field Customization -->
                    <div style="flex: 1; background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #e0e0e0; display: flex; flex-direction: column;">
                        <h5 class="subtitle is-5" style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-sliders-h"></i> Field Customization
                        </h5>
                        
                        <div class="notification is-warning is-light" style="padding: 1rem; margin-bottom: 20px;">
                            <p style="font-size: 0.95rem; text-align: center;">
                                <strong>Human Gut:</strong> Using <strong>45</strong> of <strong>82</strong> available fields
                            </p>
                        </div>
                        
                        <!-- Field categories with better spacing -->
                        <div style="flex: 1;">
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-exclamation-circle" style="color: #ff3860;"></i> Mandatory Fields
                                    </span>
                                    <span class="tag is-danger is-light">15 fields</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #7a7a7a; margin-left: 28px;">
                                    sample_id, collection_date, geographic_location...
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-check-square" style="color: #48c774;"></i> Selected Optional
                                    </span>
                                    <span class="tag is-success is-light">30 fields</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #7a7a7a; margin-left: 28px;">
                                    host_age, host_diet, antibiotics_use, BMI...
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-square" style="color: #dbdbdb;"></i> Available Optional
                                    </span>
                                    <span class="tag is-light">37 fields</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #7a7a7a; margin-left: 28px;">
                                    host_genotype, medication_history, lifestyle...
                                </div>
                            </div>
                        </div>
                        
                        <button class="button is-warning is-fullwidth" style="margin-bottom: 15px;">
                            <span class="icon"><i class="fas fa-edit"></i></span>
                            <span>Customize Field Selection</span>
                        </button>
                        
                        <div style="padding: 10px; background: white; border-radius: 6px; font-size: 0.85rem; text-align: center; color: #7a7a7a;">
                            <i class="fas fa-info-circle" style="color: #3273dc;"></i>
                            Fields parsed from NCBI MIxS XML standards
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel C: Spreadsheet Interface (from samples.html) -->
            <div class="panel" id="panel-c">
                <button class="button is-small panel-export" onclick="exportPanel('panel-c', 'spreadsheet')">
                    <span class="icon"><i class="fas fa-download"></i></span>
                </button>
                <div class="panel-header">
                    <span class="panel-label">C</span>
                    <span class="panel-title">Spreadsheet Data Entry</span>
                </div>
                <div class="panel-content">
                    <div class="sample-actions">
                        <div class="sample-info">
                            <h3 class="title">Sample Data Entry</h3>
                            <p class="subtitle">Combining Order & MIxS Fields</p>
                        </div>
                    </div>
                    
                    <!-- Field Source Indicator -->
                    <div style="display: flex; gap: 15px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #e3f2fd; border: 2px solid #3273dc; border-radius: 4px;"></div>
                            <span style="font-size: 0.875rem;">Order Fields (Sample ID, Instrument)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #fff3cd; border: 2px solid #ffdd57; border-radius: 4px;"></div>
                            <span style="font-size: 0.875rem;">MIxS Fields (Sample metadata)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="color: red;">*</span>
                            <span style="font-size: 0.875rem;">Required</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 20px;">
                        <!-- Spreadsheet container -->
                        <div style="flex: 1.5;">
                            <div class="handsontable-container" style="position: relative;">
                                <div id="hot-preview"></div>
                            </div>
                        </div>
                        
                        <!-- Field Help Panel -->
                        <div style="flex: 1; background: #f8f9fa; border-radius: 6px; padding: 15px; border: 1px solid #e0e0e0;">
                            <h6 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-info-circle"></i> Field Information
                            </h6>
                            
                            <div style="background: white; border-radius: 4px; padding: 12px; border: 1px solid #e0e0e0;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="width: 20px; height: 20px; background: #fff3cd; border: 2px solid #ffdd57; border-radius: 4px;"></div>
                                    <strong style="font-size: 0.9rem;">collection_date</strong>
                                    <span style="color: red;">*</span>
                                </div>
                                
                                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                                    The date the sample was collected, in ISO 8601 format (YYYY-MM-DD)
                                </p>
                                
                                <div style="background: #f0f7ff; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                    <strong style="font-size: 0.8rem;">Format:</strong>
                                    <code style="font-size: 0.8rem;">YYYY-MM-DD</code>
                                </div>
                                
                                <div style="background: #fff8dc; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                    <strong style="font-size: 0.8rem;">Example:</strong>
                                    <code style="font-size: 0.8rem;">2024-01-15</code>
                                </div>
                                
                                <div style="background: #ffebee; padding: 8px; border-radius: 4px;">
                                    <strong style="font-size: 0.8rem;">Validation:</strong>
                                    <span style="font-size: 0.8rem;">Required, Date format</span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 4px; font-size: 0.8rem;">
                                <i class="fas fa-mouse-pointer" style="color: #4caf50;"></i>
                                Click any cell to see field-specific help and validation rules
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conceptual note -->
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 0.85rem;">
                        <i class="fas fa-lightbulb" style="color: #4caf50;"></i>
                        <strong>Smart Integration:</strong> Fields from sequencing order (library_id, instrument_model) seamlessly combine with MIxS checklist fields (host_age, geographic_location) in a unified spreadsheet interface
                    </div>
                </div>
            </div>
            
            <!-- Panel D: Admin Dashboard -->
            <div class="panel" id="panel-d">
                <button class="button is-small panel-export" onclick="exportPanel('panel-d', 'dashboard')">
                    <span class="icon"><i class="fas fa-download"></i></span>
                </button>
                <div class="panel-header">
                    <span class="panel-label">D</span>
                    <span class="panel-title">Facility Admin Dashboard</span>
                </div>
                <div class="panel-content">
                    <div class="stat-cards">
                        <div class="stat-card">
                            <div class="stat-number">24</div>
                            <div class="stat-label">Active Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">156</div>
                            <div class="stat-label">Total Samples</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">8</div>
                            <div class="stat-label">Processing</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">142</div>
                            <div class="stat-label">Submitted to ENA</div>
                        </div>
                    </div>
                    
                    <table class="table is-fullwidth is-hoverable order-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Project</th>
                                <th>Samples</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>#2024-001</strong></td>
                                <td>Human Gut Microbiome Study</td>
                                <td>24</td>
                                <td><span class="tag is-info">Data Processing</span></td>
                                <td>
                                    <div class="buttons are-small">
                                        <button class="button is-warning is-small">
                                            <span class="icon"><i class="fas fa-file-medical"></i></span>
                                            <span>Add Read Files</span>
                                        </button>
                                        <button class="button is-primary is-small">
                                            <span class="icon"><i class="fas fa-play"></i></span>
                                            <span>Run nf-core/mag</span>
                                        </button>
                                        <button class="button is-info is-small is-light">
                                            <span class="icon"><i class="fas fa-upload"></i></span>
                                            <span>Submit to ENA</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>#2024-002</strong></td>
                                <td>Soil Metagenome Project</td>
                                <td>16</td>
                                <td><span class="tag is-success">Completed</span></td>
                                <td>
                                    <button class="button is-small is-light">
                                        <span class="icon"><i class="fas fa-download"></i></span>
                                        <span>Download Data</span>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>#2024-003</strong></td>
                                <td>Water Quality Monitoring</td>
                                <td>32</td>
                                <td><span class="tag is-warning">Sequencing in Progress</span></td>
                                <td>
                                    <button class="button is-warning is-small">
                                        <span class="icon"><i class="fas fa-file-medical"></i></span>
                                        <span>Add Read Files</span>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 0.85rem;">
                        <i class="fas fa-info-circle" style="color: #4caf50;"></i>
                        <strong>Facility Dashboard:</strong> Track order status, upload sequencing data, trigger bioinformatics pipelines, and manage batch ENA submissions from a centralized interface
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include Handsontable JS for demo -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>
    <script>
    // Initialize Handsontable for demo
    const container = document.getElementById('hot-preview');
    const hot = new Handsontable(container, {
        data: [
            {sample_id: 'HG_001', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-15', geographic_location: 'Germany: Munich', host_age: '32'},
            {sample_id: 'HG_002', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-16', geographic_location: 'Germany: Munich', host_age: '28'},
            {sample_id: 'HG_003', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-17', geographic_location: 'Germany: Berlin', host_age: '45'},
            {sample_id: 'HG_004', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-18', geographic_location: 'Germany: Hamburg', host_age: '55'},
            {sample_id: 'HG_005', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-19', geographic_location: 'Germany: Frankfurt', host_age: '41'},
            {sample_id: 'HG_006', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-20', geographic_location: 'Germany: Cologne', host_age: '38'},
            {sample_id: 'HG_007', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-21', geographic_location: 'Germany: Stuttgart', host_age: '29'},
            {sample_id: 'HG_008', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-22', geographic_location: 'Germany: Dresden', host_age: '47'},
            {sample_id: 'HG_009', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-23', geographic_location: 'Germany: Leipzig', host_age: '33'},
            {sample_id: 'HG_010', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-24', geographic_location: 'Germany: Bremen', host_age: '52'},
            {sample_id: 'HG_011', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-25', geographic_location: 'Germany: Essen', host_age: '37'},
            {sample_id: 'HG_012', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-26', geographic_location: 'Germany: Dortmund', host_age: '44'},
            {sample_id: 'HG_013', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-27', geographic_location: 'Germany: Nuremberg', host_age: '31'},
            {sample_id: 'HG_014', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-28', geographic_location: 'Germany: Hannover', host_age: '49'},
            {sample_id: 'HG_015', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-29', geographic_location: 'Germany: Bonn', host_age: '26'},
            {sample_id: 'HG_016', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-30', geographic_location: 'Germany: Freiburg', host_age: '39'},
            {sample_id: 'HG_017', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-01-31', geographic_location: 'Germany: Heidelberg', host_age: '42'},
            {sample_id: 'HG_018', instrument_model: 'Illumina NovaSeq 6000', collection_date: '2024-02-01', geographic_location: 'Germany: Mannheim', host_age: '36'},
        ],
        columns: [
            {data: 'sample_id', title: 'Sample ID <span style="color: red;">*</span>'},
            {data: 'instrument_model', title: 'Instrument Model'},
            {data: 'collection_date', title: 'Collection Date <span style="color: red;">*</span>', type: 'date'},
            {data: 'geographic_location', title: 'Geographic Location <span style="color: red;">*</span>'},
            {data: 'host_age', title: 'Host Age', type: 'numeric'}
        ],
        afterGetColHeader: function(col, TH) {
            // Add background colors to headers based on field type
            if (col === 0 || col === 1) {
                TH.style.background = '#e3f2fd'; // Order fields (sample_id, instrument_model)
            } else {
                TH.style.background = '#fff3cd'; // MIxS fields
            }
        },
        rowHeaders: true,
        colHeaders: true,
        stretchH: 'all',
        height: 440,
        licenseKey: 'non-commercial-and-evaluation',
        contextMenu: true,
        manualRowMove: true,
        manualColumnMove: true,
        filters: true,
        dropdownMenu: true,
        columnSorting: true,
        autoColumnSize: true,
        className: 'htCenter',
        headerClassName: 'htCenter'
    });
    
    // Export functions
    function exportPanel(panelId, filename) {
        const panel = document.getElementById(panelId);
        const exportBtn = panel.querySelector('.panel-export');
        exportBtn.style.display = 'none'; // Hide export button during capture
        
        html2canvas(panel, {
            backgroundColor: '#ffffff',
            scale: 2, // Higher resolution
            logging: false
        }).then(canvas => {
            // Create PDF
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`b4m_${filename}_panel.pdf`);
            
            exportBtn.style.display = ''; // Show button again
        });
    }
    
    function exportAllPanels() {
        const panels = ['panel-a', 'panel-b', 'panel-c', 'panel-d'];
        
        // Hide all export buttons
        document.querySelectorAll('.panel-export').forEach(btn => btn.style.display = 'none');
        document.querySelector('.export-controls').style.display = 'none';
        
        // Wait a bit for rendering
        setTimeout(() => {
            // Capture all panels
            Promise.all(panels.map(panelId => 
                html2canvas(document.getElementById(panelId), {
                    backgroundColor: '#ffffff',
                    scale: 3, // Higher resolution
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                })
            )).then(canvases => {
                // Create single PDF with all panels
                const pdf = new jspdf.jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a3'
                });
                
                // Calculate dimensions to maintain aspect ratio
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                const panelWidth = (pageWidth - 3 * margin) / 2;
                const panelHeight = (pageHeight - 3 * margin) / 2;
                
                // Add panels in 2x2 grid maintaining aspect ratio
                canvases.forEach((canvas, i) => {
                    const imgData = canvas.toDataURL('image/png');
                    const canvasRatio = canvas.width / canvas.height;
                    const panelRatio = panelWidth / panelHeight;
                    
                    let drawWidth = panelWidth;
                    let drawHeight = panelHeight;
                    let offsetX = 0;
                    let offsetY = 0;
                    
                    if (canvasRatio > panelRatio) {
                        // Canvas is wider
                        drawHeight = drawWidth / canvasRatio;
                        offsetY = (panelHeight - drawHeight) / 2;
                    } else {
                        // Canvas is taller
                        drawWidth = drawHeight * canvasRatio;
                        offsetX = (panelWidth - drawWidth) / 2;
                    }
                    
                    const x = margin + (i % 2) * (panelWidth + margin) + offsetX;
                    const y = margin + Math.floor(i / 2) * (panelHeight + margin) + offsetY;
                    
                    pdf.addImage(imgData, 'PNG', x, y, drawWidth, drawHeight);
                });
                
                pdf.save('b4m_figure_all_panels.pdf');
                
                // Show buttons again
                document.querySelectorAll('.panel-export').forEach(btn => btn.style.display = '');
                document.querySelector('.export-controls').style.display = '';
            });
        }, 100);
    }
    
    function exportAllPanelsSVG() {
        // For true SVG export, we need to convert the HTML to SVG
        // This is a simplified approach that creates downloadable SVG files
        const panels = document.querySelectorAll('.panel');
        
        panels.forEach((panel, index) => {
            const panelClone = panel.cloneNode(true);
            // Remove export button from clone
            const exportBtn = panelClone.querySelector('.panel-export');
            if (exportBtn) exportBtn.remove();
            
            // Create SVG with foreignObject
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
            
            // Get panel dimensions
            const rect = panel.getBoundingClientRect();
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);
            svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
            
            foreignObject.setAttribute('width', '100%');
            foreignObject.setAttribute('height', '100%');
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = Array.from(document.styleSheets)
                .map(sheet => {
                    try {
                        return Array.from(sheet.cssRules)
                            .map(rule => rule.cssText)
                            .join('\n');
                    } catch (e) {
                        return '';
                    }
                })
                .join('\n');
            
            foreignObject.appendChild(style);
            foreignObject.appendChild(panelClone);
            svg.appendChild(foreignObject);
            
            // Convert to blob and download
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `b4m_panel_${String.fromCharCode(65 + index)}.svg`;
            a.click();
            URL.revokeObjectURL(url);
        });
    }
    
    // High resolution PNG export
    function exportHighResPNG() {
        // Hide controls
        document.querySelectorAll('.panel-export').forEach(btn => btn.style.display = 'none');
        document.querySelector('.export-controls').style.display = 'none';
        
        // Get the entire figure container
        const figureContainer = document.querySelector('.figure-container');
        
        setTimeout(() => {
            html2canvas(figureContainer, {
                backgroundColor: '#ffffff',
                scale: 4, // 4x resolution for print quality
                logging: false,
                useCORS: true,
                allowTaint: true,
                windowWidth: 1800,
                windowHeight: 1200
            }).then(canvas => {
                // Convert to blob and download
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'b4m_figure_high_resolution.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    // Show controls again
                    document.querySelectorAll('.panel-export').forEach(btn => btn.style.display = '');
                    document.querySelector('.export-controls').style.display = '';
                }, 'image/png', 1.0); // Maximum quality
            });
        }, 100);
    }
    </script>
</body>
</html>